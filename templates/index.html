<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPY/QQQ Dashboard - Options Greeks Analysis</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            zoom: 90%;
        }

        :root {
            --primary: #8b5cf6;
            --primary-light: #a78bfa;
            --primary-dark: #6d28d9;
            --accent: #ec4899;
            --bg-dark: #000000;
            --bg-card: rgba(10, 10, 10, 0.95);
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(139, 92, 246, 0.3);
            --success: #10b981;
            --danger: #ef4444;
        }

        body {
            background: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 15% 30%, rgba(139, 92, 246, 0.08) 0%, transparent 60%),
                radial-gradient(circle at 85% 70%, rgba(236, 72, 153, 0.06) 0%, transparent 60%),
                radial-gradient(circle at 50% 50%, rgba(109, 40, 217, 0.04) 0%, transparent 70%);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            padding: 15px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1920px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 35px 25px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(30, 10, 40, 0.95) 100%);
            border-radius: 20px;
            box-shadow: 
                0 8px 32px rgba(139, 92, 246, 0.25),
                0 0 80px rgba(139, 92, 246, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
            animation: rotate 20s linear infinite;
            pointer-events: none;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.8em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-weight: 900;
            letter-spacing: 2px;
            text-shadow: 0 0 40px rgba(139, 92, 246, 0.3);
            animation: glow 3s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border-radius: 12px;
            color: white;
            text-decoration: none;
            font-weight: 900;
            font-size: 0.85em;
            letter-spacing: 1px;
            text-transform: uppercase;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            z-index: 10;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.5);
        }

        .header-subtitle {
            color: var(--text-secondary);
            font-size: 0.9em;
            font-weight: 400;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .stat {
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .stat::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(139, 92, 246, 0.1), transparent);
            transition: left 0.5s;
        }

        .stat:hover::before {
            left: 100%;
        }

        .stat:hover {
            background: rgba(20, 10, 30, 0.7);
            border-color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.3);
        }

        .stat-label {
            color: var(--text-muted);
            font-weight: 700;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
            display: block;
        }

        .stat-value {
            color: var(--primary-light);
            font-weight: 900;
            font-size: 1.1em;
            text-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
            display: block;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 25px 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .ticker-section {
            display: flex;
            gap: 10px;
            padding: 8px 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .ticker-btn {
            padding: 10px 22px;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(20, 10, 30, 0.9) 100%);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--primary);
            font-family: inherit;
            font-size: 0.9em;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ticker-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .ticker-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #34d399;
            color: #ffffff;
            box-shadow: 0 6px 30px rgba(16, 185, 129, 0.5);
            transform: scale(1.05);
        }

        .dte-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(20, 10, 30, 0.9) 100%);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--primary);
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .dte-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .dte-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .dte-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .dte-btn.active {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            border-color: var(--primary-light);
            color: #ffffff;
            box-shadow: 
                0 6px 30px rgba(139, 92, 246, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transform: scale(1.05);
        }

        .dte-btn span {
            position: relative;
            z-index: 1;
        }

        .auto-fit-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2) 0%, rgba(124, 58, 237, 0.2) 100%);
            border: 2px solid #8b5cf6;
            border-radius: 12px;
            color: #8b5cf6;
            font-family: inherit;
            font-size: 0.85em;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
            margin-left: 15px;
        }

        .auto-fit-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .auto-fit-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .auto-fit-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3) 0%, rgba(124, 58, 237, 0.3) 100%);
            border-color: #a78bfa;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.4);
        }

        .auto-fit-btn span {
            position: relative;
            z-index: 1;
        }

        .charts-container {
            display: grid;
            gap: 30px;
        }

        .chart-wrapper {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(20, 10, 30, 0.95) 100%);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 
                0 10px 50px rgba(0, 0, 0, 0.8),
                0 0 60px rgba(139, 92, 246, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            backdrop-filter: blur(20px);
        }

        .chart-wrapper:hover {
            box-shadow: 
                0 15px 70px rgba(0, 0, 0, 0.9),
                0 0 80px rgba(139, 92, 246, 0.25);
            border-color: var(--primary-light);
            transform: translateY(-5px);
        }

        .chart-title {
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
        }

        .crosshair-h {
            position: absolute;
            width: 100%;
            height: 2px;
            background-color: #6b7280;
            pointer-events: none;
            opacity: 0;
            z-index: 1000;
            left: 0;
        }

        .chart-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(20, 10, 40, 0.95) 100%);
            border-radius: 20px;
            color: var(--text-secondary);
            border: 1px solid var(--border);
            font-size: 0.85em;
            line-height: 1.8;
            backdrop-filter: blur(20px);
        }

        .footer-highlight {
            color: var(--primary-light);
            font-weight: 700;
        }

        .loading {
            text-align: center;
            padding: 120px 20px;
            font-size: 2em;
            color: var(--primary);
            animation: pulse 2s ease-in-out infinite;
            font-weight: 900;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.4;
                transform: scale(1.05);
            }
        }

        .error-message {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }

        @media (max-width: 1400px) {
            .chart-row {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }

            .logout-btn {
                position: static;
                display: block;
                margin: 15px auto 0;
                width: fit-content;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                gap: 8px;
            }

            .ticker-section {
                width: 100%;
                justify-content: center;
            }

            .dte-btn {
                padding: 10px 18px;
                font-size: 0.8em;
            }

            .auto-fit-btn {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/logout" class="logout-btn">üö™ LOGOUT</a>
            <div class="header-content">
                <h1>üìä <span id="header-ticker">SPY</span> DASHBOARD</h1>
                <div class="header-subtitle">Options Greeks Analysis</div>
                <div class="stats">
                    <div class="stat">
                        <span class="stat-label">üìà Ticker</span>
                        <span class="stat-value" id="ticker">SPY</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">üíµ Spot</span>
                        <span class="stat-value" id="spot">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">üìÖ Expiry</span>
                        <span class="stat-value" id="expiration">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">‚è±Ô∏è DTE</span>
                        <span class="stat-value" id="dte">--</span>
                    </div>
                    <div class="stat">
                        <span class="stat-label">üîÑ Updated</span>
                        <span class="stat-value" id="timestamp">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="ticker-section">
                <button class="ticker-btn active" onclick="changeTicker('SPY')" id="ticker-SPY">SPY</button>
                <button class="ticker-btn" onclick="changeTicker('QQQ')" id="ticker-QQQ">QQQ</button>
            </div>

            <button class="dte-btn active" onclick="changeDTE(0)" id="dte-0"><span>0DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(1)" id="dte-1"><span>1DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(2)" id="dte-2"><span>2DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(3)" id="dte-3"><span>3DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(4)" id="dte-4"><span>4DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(5)" id="dte-5"><span>5DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(98)" id="dte-98"><span>98DTE</span></button>
            <button class="dte-btn" onclick="changeDTE(365)" id="dte-365"><span>365DTE</span></button>
            <button class="auto-fit-btn" onclick="autoFitAll()"><span>üéØ AUTO FIT</span></button>
        </div>

        <div id="loading" class="loading">‚è≥ Loading data...</div>

        <div class="charts-container" id="charts" style="display: none;">
            <div class="chart-wrapper">
                <div class="chart-title">üéØ GAMMA EXPOSURE</div>
                <div class="chart-container">
                    <div class="crosshair-h" id="crosshair-gex"></div>
                    <div id="gex-chart"></div>
                </div>
            </div>

            <div class="chart-row">
                <div class="chart-wrapper">
                    <div class="chart-title">‚ö° CHARM EXPOSURE</div>
                    <div class="chart-container">
                        <div class="crosshair-h" id="crosshair-charm"></div>
                        <div id="charm-chart"></div>
                    </div>
                </div>

                <div class="chart-wrapper">
                    <div class="chart-title">üíé VANNA EXPOSURE</div>
                    <div class="chart-container">
                        <div class="crosshair-h" id="crosshair-vanna"></div>
                        <div id="vanna-chart"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <strong>$1 Strike Interval (0-5DTE) | $5 Strike Interval (98-365DTE)</strong> ‚Ä¢ Black-Scholes Greeks Model ‚Ä¢ Real-time Yahoo Finance Data<br>
            <span class="footer-highlight">üí° Zoom Y:</span> Molette sur colonne Strike ‚Ä¢ 
            <span class="footer-highlight">üí° Zoom X:</span> Molette sur axe horizontal ‚Ä¢ 
            <span class="footer-highlight">üñ±Ô∏è Stretch:</span> Clic+Drag ‚Ä¢ 
            <span class="footer-highlight">üéØ Auto Fit:</span> R√©ajuste tout automatiquement ‚Ä¢ 
            <span class="footer-highlight">üîÑ Auto-refresh:</span> 2 min
        </div>
    </div>

    <script>
        let currentDTE = 0;
        let currentTicker = 'SPY';
        let currentData = null;
        let dataCache = {};
        let isLoading = false;

        function setupCrosshair(chartDivId, crosshairId) {
            const chartDiv = document.getElementById(chartDivId);
            const crosshair = document.getElementById(crosshairId);

            chartDiv.addEventListener('mousemove', function(e) {
                const rect = chartDiv.getBoundingClientRect();
                const y = e.clientY - rect.top;
                crosshair.style.top = y + 'px';
                crosshair.style.opacity = '0.7';
            });

            chartDiv.addEventListener('mouseleave', function() {
                crosshair.style.opacity = '0';
            });
        }

        function changeTicker(ticker) {
            currentTicker = ticker;
            document.querySelectorAll('.ticker-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`ticker-${ticker}`).classList.add('active');
            document.getElementById('header-ticker').textContent = ticker;
            loadData();
        }

        function changeDTE(dte) {
            currentDTE = dte;
            document.querySelectorAll('.dte-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`dte-${dte}`).classList.add('active');
            loadData();
        }

        function autoFitAll() {
            if (!currentData) return;
            displayData(currentData);
        }

        async function loadData() {
            if (isLoading) return;

            const cacheKey = `${currentTicker}_dte${currentDTE}`;
            const now = Date.now();

            if (dataCache[cacheKey] && (now - dataCache[cacheKey].timestamp < 30000)) {
                displayData(dataCache[cacheKey].data);
                return;
            }

            isLoading = true;
            document.getElementById('loading').style.display = 'block';

            try {
                const response = await fetch(`/api/data?dte=${currentDTE}&ticker=${currentTicker}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                dataCache[cacheKey] = { data, timestamp: now };
                displayData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').innerHTML = '<div class="error-message">‚ùå Failed to load data. Retrying in 5s...</div>';
                setTimeout(loadData, 5000);
            } finally {
                isLoading = false;
            }
        }

        function displayData(data) {
            currentData = data;

            document.getElementById('ticker').textContent = data.ticker;
            document.getElementById('spot').textContent = '$' + data.spot.toFixed(2);
            document.getElementById('expiration').textContent = data.expiration;
            document.getElementById('dte').textContent = data.dte + 'd';
            document.getElementById('timestamp').textContent = data.timestamp;

            document.getElementById('loading').style.display = 'none';
            document.getElementById('charts').style.display = 'grid';

            requestAnimationFrame(() => {
                createChart('gex-chart', data, 'GEX', 'call_gex', 'put_gex', 'total_gex', 'Millions $', 650);
                createChart('charm-chart', data, 'Charm', 'call_charm', 'put_charm', 'total_charm', 'Delta/Day', 850);
                createChart('vanna-chart', data, 'Vanna', 'call_vanna', 'put_vanna', 'total_vanna', 'Delta/Vol%', 850);

                setTimeout(() => {
                    setupCrosshair('gex-chart', 'crosshair-gex');
                    setupCrosshair('charm-chart', 'crosshair-charm');
                    setupCrosshair('vanna-chart', 'crosshair-vanna');
                }, 200);
            });
        }

        function createChart(divId, data, title, callKey, putKey, totalKey, unit, chartHeight) {
            const putGEX = data[putKey].map((val, idx) => ({ strike: data.strikes[idx], value: Math.abs(val) }));
            const callGEX = data[callKey].map((val, idx) => ({ strike: data.strikes[idx], value: Math.abs(val) }));

            const putWall = putGEX.reduce((max, curr) => curr.value > max.value ? curr : max, putGEX[0]);
            const callWall = callGEX.reduce((max, curr) => curr.value > max.value ? curr : max, callGEX[0]);

            const volTrigger = data[totalKey].map((val, idx) => ({ strike: data.strikes[idx], value: Math.abs(val) }))
                .reduce((min, curr) => curr.value < min.value ? curr : min, { strike: data.strikes[0], value: Math.abs(data[totalKey][0]) });

            const trace1 = {
                y: data.strikes,
                x: data[putKey].map(val => -Math.abs(val)),
                type: 'bar',
                orientation: 'h',
                name: 'Puts',
                marker: {
                    color: '#8b5cf6',
                    line: { color: '#a78bfa', width: 1.5 },
                    opacity: 0.95
                },
                hoverinfo: 'skip'
            };

            const trace2 = {
                y: data.strikes,
                x: data[callKey].map(val => Math.abs(val)),
                type: 'bar',
                orientation: 'h',
                name: 'Calls',
                marker: {
                    color: '#ffffff',
                    line: { color: '#e5e5e5', width: 1.5 },
                    opacity: 0.98
                },
                hoverinfo: 'skip'
            };

            const shapes = [
                { type: 'line', y0: data.spot, y1: data.spot, x0: 0, x1: 1, xref: 'paper', line: { color: '#9ca3af', width: 3, dash: 'dot' } },
                { type: 'line', y0: putWall.strike, y1: putWall.strike, x0: 0, x1: 1, xref: 'paper', line: { color: '#a78bfa', width: 2, dash: 'dash' } },
                { type: 'line', y0: callWall.strike, y1: callWall.strike, x0: 0, x1: 1, xref: 'paper', line: { color: '#ffffff', width: 2, dash: 'dash' } },
                { type: 'line', y0: volTrigger.strike, y1: volTrigger.strike, x0: 0, x1: 1, xref: 'paper', line: { color: '#7c3aed', width: 2, dash: 'dot' } }
            ];

            const annotations = [
                { y: data.spot, x: 1.01, xref: 'paper', text: `Spot: $${data.spot.toFixed(2)}`, showarrow: false, font: { color: '#9ca3af', size: 11, weight: 'bold', family: 'JetBrains Mono' }, xanchor: 'left', bgcolor: 'transparent', borderpad: 0 },
                { y: putWall.strike, x: 1.01, xref: 'paper', text: `Put Wall: ${putWall.strike.toFixed(0)}`, showarrow: false, font: { color: '#a78bfa', size: 11, weight: 'bold', family: 'JetBrains Mono' }, xanchor: 'left', bgcolor: 'transparent', borderpad: 0 },
                { y: callWall.strike, x: 1.01, xref: 'paper', text: `Call Wall: ${callWall.strike.toFixed(0)}`, showarrow: false, font: { color: '#ffffff', size: 11, weight: 'bold', family: 'JetBrains Mono' }, xanchor: 'left', bgcolor: 'transparent', borderpad: 0 },
                { y: volTrigger.strike, x: 1.01, xref: 'paper', text: `Vol Trigger: ${volTrigger.strike.toFixed(0)}`, showarrow: false, font: { color: '#7c3aed', size: 11, weight: 'bold', family: 'JetBrains Mono' }, xanchor: 'left', bgcolor: 'transparent', borderpad: 0 }
            ];

            // AUTO ZOOM Y-AXIS SELON DTE
            let yRangeMin, yRangeMax;
            if (currentDTE >= 98) {
                // 98DTE et 365DTE : AFFICHER TOUS LES STRIKES (vue d'ensemble)
                const minStrike = Math.min(...data.strikes);
                const maxStrike = Math.max(...data.strikes);
                yRangeMin = minStrike;
                yRangeMax = maxStrike;
            } else if (currentDTE >= 1 && currentDTE <= 5) {
                // 1-5 DTE : zoom mod√©r√©
                yRangeMin = data.spot - 15;
                yRangeMax = data.spot + 15;
            } else {
                // 0DTE : zoom proche du spot
                yRangeMin = data.spot - 15;
                yRangeMax = data.spot + 15;
            }

            // AUTO ZOOM X-AXIS : CENTRER LE Z√âRO
            const allPutValues = data[putKey].map(val => Math.abs(val));
            const allCallValues = data[callKey].map(val => Math.abs(val));
            const maxPut = Math.max(...allPutValues);
            const maxCall = Math.max(...allCallValues);
            const maxAbsValue = Math.max(maxPut, maxCall);
            
            // Padding de 20% pour une vue d'ensemble propre
            const xPadding = maxAbsValue * 0.2;
            const xRangeMax = maxAbsValue + xPadding;

            const layout = {
                barmode: 'relative',
                bargap: 0,
                bargroupgap: 0,
                height: chartHeight,
                paper_bgcolor: '#000000',
                plot_bgcolor: '#0a0a0a',
                font: { family: 'JetBrains Mono, monospace', color: '#e2e8f0', size: 11 },
                xaxis: {
                    title: { text: unit, font: { size: 13, color: '#8b5cf6', weight: 'bold' } },
                    gridcolor: '#1a1a1a',
                    zerolinecolor: '#8b5cf6',
                    zerolinewidth: 3,
                    tickfont: { size: 10, color: '#94a3b8' },
                    showgrid: true,
                    range: [-xRangeMax, xRangeMax],
                    fixedrange: false
                },
                yaxis: {
                    title: { text: 'Strike', font: { size: 13, color: '#8b5cf6', weight: 'bold' } },
                    gridcolor: '#1a1a1a',
                    tickformat: '.0f',
                    tickfont: { size: 10, color: '#e2e8f0' },
                    showgrid: true,
                    tickmode: 'array',
                    tickvals: data.strikes,
                    range: [yRangeMin, yRangeMax],
                    fixedrange: false
                },
                shapes: shapes,
                annotations: annotations,
                showlegend: false,
                margin: { l: 75, r: 150, t: 25, b: 65 },
                hovermode: false,
                dragmode: 'pan'
            };

            const config = {
                responsive: true,
                displayModeBar: true,
                displaylogo: false,
                scrollZoom: false,
                doubleClick: 'reset',
                modeBarButtonsToRemove: ['select2d', 'lasso2d'],
                toImageButtonOptions: {
                    format: 'png',
                    filename: data.ticker + '_' + title + '_' + new Date().toISOString().slice(0,10),
                    height: 1080,
                    width: 1920,
                    scale: 2
                }
            };

            Plotly.newPlot(divId, [trace1, trace2], layout, config);

            const chartDiv = document.getElementById(divId);
            chartDiv.addEventListener('wheel', function(e) {
                const bbox = chartDiv.getBoundingClientRect();
                const mouseX = e.clientX - bbox.left;
                const mouseY = e.clientY - bbox.top;
                const chartBottom = bbox.height - 65;

                if (mouseX < 75 && mouseY < chartBottom) {
                    e.preventDefault();
                    const currentYRange = chartDiv.layout.yaxis.range;
                    const yCenter = (currentYRange[0] + currentYRange[1]) / 2;
                    const ySpan = currentYRange[1] - currentYRange[0];
                    const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                    const newYSpan = ySpan * zoomFactor;
                    Plotly.relayout(divId, { 'yaxis.range': [yCenter - newYSpan/2, yCenter + newYSpan/2] });
                } else if (mouseY >= chartBottom && mouseX >= 75) {
                    e.preventDefault();
                    const currentXRange = chartDiv.layout.xaxis.range;
                    const xCenter = (currentXRange[0] + currentXRange[1]) / 2;
                    const xSpan = currentXRange[1] - currentXRange[0];
                    const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                    const newXSpan = xSpan * zoomFactor;
                    Plotly.relayout(divId, { 'xaxis.range': [xCenter - newXSpan/2, xCenter + newXSpan/2] });
                }
            }, { passive: false });
        }

        loadData();

        setInterval(() => {
            if (!isLoading && !Object.keys(dataCache).length) {
                loadData();
            }
        }, 120000);
    </script>
</body>
</html>
